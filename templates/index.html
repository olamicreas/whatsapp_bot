{% extends "layout.html" %}
{% block content %}
<!-- App Container -->
<div class="bg-white text-gray-900 rounded-3xl shadow-2xl p-5 sm:p-6 space-y-5 max-w-md mx-auto">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-extrabold text-gray-800">Referral Program</h1>
      <p class="text-xs text-gray-500">Join, share, and climb the leaderboard</p>
    </div>
    <div class="flex gap-2">
      <a href="/public" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-indigo-50 to-cyan-50 hover:from-indigo-100 hover:to-cyan-100 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10M12 7v10M16 7v10"/>
        </svg>
        <span class="text-xs font-semibold text-indigo-600">Leaderboard</span>
      </a>
    </div>
  </div>

  <!-- Registration Card -->
  <div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm">
    <div class="p-4 bg-gradient-to-r from-slate-700 via-slate-600 to-slate-500 text-white">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-bold">Join the Challenge</h2>
          <p class="text-xs opacity-90">We'll assign a team or solo referral link automatically</p>
        </div>
        <div class="text-right text-xs">
          <span class="block opacity-80">Teams</span>
          <span class="font-bold text-2xl">1 â†’ 5</span>
        </div>
      </div>
    </div>

    <!-- Registration form: note id and hidden admin input -->
    <form id="registerForm" method="POST" action="/register" class="p-4 bg-white" onsubmit="return requireAdminPassword(event)">
      <label class="block text-xs text-gray-500 mb-1">Your Name</label>
      <input name="name" required
             class="w-full p-3 rounded-xl border border-gray-200 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-400"
             placeholder="e.g. Abdul Oyedotun" />

      <!-- Registration type: Team or Solo (default Team) -->
      <div class="mb-4 flex items-center gap-4 text-sm">
        <label class="inline-flex items-center">
          <input type="radio" name="registration_type" value="team" checked class="form-radio"/>
          <span class="ml-2">Group / Team</span>
        </label>
        <label class="inline-flex items-center">
          <input type="radio" name="registration_type" value="solo" class="form-radio"/>
          <span class="ml-2">Solo / Individual</span>
        </label>
      </div>

      <!-- hidden admin password input (populated by modal) -->
      <input type="hidden" name="admin_password" id="admin_password_input" value="">

      <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-slate-700 via-slate-600 to-slate-500 text-white font-bold shadow-md hover:opacity-95 transition">
        Create Account
      </button>
    </form>
  </div>

  <!-- Quick Lookup -->
  <div class="rounded-2xl bg-gray-50 border border-gray-100 p-3 shadow-sm">
    <label class="block text-xs text-gray-500 mb-2">Already registered?</label>
    <form onsubmit="redirectToProgress(event)" class="flex gap-2">
      <input id="groupInput" required placeholder="Enter your name"
             class="flex-1 p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-cyan-400" />
      <button type="submit"
              class="px-4 rounded-xl bg-gradient-to-r from-cyan-500 to-indigo-500 text-white font-semibold hover:opacity-95 transition">
        View
      </button>
    </form>
    <p class="text-xs text-gray-400 mt-2">Tip: enter the exact name you registered with.</p>
  </div>

  <!-- Footer -->
  <div class="text-center text-xs text-gray-400">
    <span>Built with ðŸ’œ â€” Referral App</span>
  </div>
</div>

<!-- Admin-password modal (hidden by default) -->
<div id="adminModal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/50 px-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-xl p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Admin password required</h3>
      <button type="button" aria-label="Close" class="text-gray-500" onclick="hideAdminModal()">âœ•</button>
    </div>

    <p class="text-sm text-gray-600 mb-3">Enter the admin password to create an account.</p>

    <div class="mb-4">
      <label class="block text-xs text-gray-500 mb-1">Password</label>
      <input id="adminPasswordInput" type="password" autocomplete="current-password"
             class="w-full p-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </div>

    <div class="flex items-center gap-2">
      <button id="adminConfirmBtn" type="button" onclick="confirmAdminPassword()"
              class="flex-1 py-2 rounded-xl bg-gradient-to-r from-slate-700 via-slate-600 to-slate-500 text-white font-semibold">Confirm</button>
      <button type="button" onclick="cancelAdminModal()" class="px-4 py-2 rounded-xl border bg-white">Cancel</button>
    </div>

    <p class="mt-3 text-xs text-gray-400">If you do not have the admin password, ask an admin. Registration without the password will be rejected by the server.</p>
  </div>
</div>

<script>
/* Quick lookup redirect (unchanged) */
function redirectToProgress(e){
  e.preventDefault();
  const name = document.getElementById('groupInput').value.trim().toLowerCase().replace(/\s+/g,'_');
  if(name) window.location.href = `/progress/${name}`;
}

/* Admin-password modal flow */
let _pendingForm = null;

function requireAdminPassword(e) {
  // Prevent default submission; show modal which will confirm and submit.
  e.preventDefault();
  _pendingForm = e.target || document.getElementById('registerForm');
  showAdminModal();
  return false;
}

function showAdminModal() {
  const modal = document.getElementById('adminModal');
  modal.classList.remove('hidden');
  // small delay so focus works after display
  setTimeout(() => document.getElementById('adminPasswordInput').focus(), 50);
  // Allow ESC to close
  document.addEventListener('keydown', _handleEsc);
}

function hideAdminModal() {
  const modal = document.getElementById('adminModal');
  modal.classList.add('hidden');
  document.removeEventListener('keydown', _handleEsc);
  // clear password field for security
  document.getElementById('adminPasswordInput').value = '';
  _pendingForm = null;
}

function cancelAdminModal() { hideAdminModal(); }

function _handleEsc(e) {
  if (e.key === 'Escape') hideAdminModal();
}

function confirmAdminPassword() {
  const pwInput = document.getElementById('adminPasswordInput');
  const pw = pwInput.value.trim();
  if (!pw) {
    // small visual feedback
    pwInput.classList.add('border-red-400');
    setTimeout(() => pwInput.classList.remove('border-red-400'), 900);
    pwInput.focus();
    return;
  }

  // copy into hidden input and submit the pending form
  document.getElementById('admin_password_input').value = pw;

  // Submit and then hide modal
  if (_pendingForm) {
    _pendingForm.submit();
  } else {
    // fallback: if no pendingForm, just submit the main register form
    document.getElementById('registerForm').submit();
  }

  // clear stored pw in JS memory
  pwInput.value = '';
  hideAdminModal();
}
</script>

<noscript>
  <div class="max-w-md mx-auto mt-4 p-3 bg-yellow-50 text-yellow-800 rounded-lg text-sm">
    JavaScript is required to enter the admin password via the page. If you have JS disabled, use an admin tool/flow or enable JS. The server will still block registration without a valid `admin_password`.
  </div>
</noscript>

{% endblock %}
