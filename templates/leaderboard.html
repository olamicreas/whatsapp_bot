{% extends "layout.html" %}
{% block content %}
<style>
  @keyframes slideUpFade {
    from { transform: translateY(18px) scale(.995); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }

  .shimmer { position: relative; overflow: hidden; }
  .shimmer::after {
    content: ""; position: absolute; inset: 0;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0) 85%);
    transform: translateX(-110%); animation: shimmer 2.5s linear infinite;
  }
  @keyframes shimmer { to { transform: translateX(110%); } }

  @keyframes growWidth { from { width: 0%; } to { width: var(--w, 0%); } }

  .bg-blob { position: absolute; inset: 0; pointer-events: none; z-index: 0; filter: blur(30px) saturate(120%); opacity: 0.18; }

  /* search box small tweaks */
  #leaderboardSearch { width: 100%; padding: .6rem .8rem; border-radius: .6rem; border: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.03); color: #fff; }
  .no-results { text-align:center; padding:1rem; color:#cbd5e1; font-size: .95rem; }
</style>

<div class="relative overflow-hidden">
  <svg class="bg-blob" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
    <defs>
      <linearGradient id="g1" x1="0" x2="1">
        <stop offset="0" stop-color="#4f46e5"/>
        <stop offset="1" stop-color="#06b6d4"/>
      </linearGradient>
      <linearGradient id="g2" x1="0" x2="1">
        <stop offset="0" stop-color="#9333ea"/>
        <stop offset="1" stop-color="#0ea5e9"/>
      </linearGradient>
    </defs>
    <ellipse cx="140" cy="480" rx="280" ry="130" fill="url(#g1)" />
    <ellipse cx="700" cy="90" rx="300" ry="160" fill="url(#g2)" />
  </svg>

  <div class="space-y-6 relative z-10 animate-fade-slide">

    <!-- Header + Search -->
    <div class="max-w-md mx-auto text-center">
      <h1 class="text-3xl sm:text-4xl font-extrabold shimmer">
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-cyan-300 via-indigo-300 to-violet-400">üèÜ Global Leaderboard</span>
      </h1>
      <p class="mt-2 text-sm text-gray-300/80">Top performing teams across all groups</p>

      <!-- Search input -->
      <div class="mt-4">
        <input id="leaderboardSearch" placeholder="Search teams, group, REF code or team number (e.g. TEAM1, REF001, GroupName)" type="search" />
      </div>
    </div>

    {# flatten all teams (excluding SOLO) for top5 calculation #}
    {% set global_flat = [] %}
    {% for group, teams in all_refs.items() %}
      {% if group != 'SOLO' %}
        {% for tid, info in teams.items() %}
          {% set _ = global_flat.append({'group': group, 'tid': tid, 'label': info.team_label, 'referrals': info.referrals|default(0)}) %}
        {% endfor %}
      {% endif %}
    {% endfor %}

    {% set top_sorted = global_flat | sort(attribute='referrals') %}
    {% set top5 = top_sorted[-5:] | reverse %}

    {% if top5 %}
    <div id="topTeams" class="max-w-md mx-auto bg-white/10 border border-white/10 rounded-3xl p-4 shadow-xl backdrop-blur-lg">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm text-gray-300">Top Teams</div>
        <div class="text-xs text-cyan-300">Live</div>
      </div>

      <div class="grid grid-cols-1 gap-2">
        {% for t in top5 %}
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl team-card"
             data-tid="{{ t.tid }}" data-label="{{ t.label }}" data-group="{{ t.group }}" style="animation: slideUpFade .45s ease both; animation-delay: {{ loop.index0 * 0.05 }}s;">
          <div>
            <div class="text-sm font-semibold text-white">{{ t.label }}</div>
            <div class="text-xs text-gray-400">{{ t.group }} ¬∑ Team {{ t.tid }}</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-extrabold text-cyan-300">{{ t.referrals }}</div>
            <a href="{{ TEAM_LINKS.get(t.tid|int, '#') }}" target="_blank" class="text-xs text-indigo-300 mt-1 block hover:underline">View</a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# SOLO / Individual REF section #}
    {% set solo = all_refs.get('SOLO') if all_refs is mapping else None %}
    {% if solo and solo|length %}
    <div id="soloSection" class="max-w-md mx-auto bg-white/6 border border-white/10 rounded-3xl p-4 shadow-lg backdrop-blur-md">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 class="text-lg font-bold text-white">Individual REF</h3>
          <p class="text-xs text-gray-400">Personal referral counts (REF001‚ÄìREF005)</p>
        </div>
        <div class="text-xs text-gray-400">Individuals</div>
      </div>

      <div class="space-y-2">
        {% for ref_key, info in solo.items() %}
        <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 solo-card"
             data-refkey="{{ ref_key }}" data-label="{{ info.team_label or ref_key }}">
          <div>
            <div class="text-sm font-semibold text-white">{{ info.team_label or ref_key }}</div>
            <div class="text-xs text-gray-400">{{ ref_key }}</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-extrabold text-cyan-300">{{ info.referrals | default(0) }}</div>
            {% if SOLO_LINKS is mapping %}
              {% set s_link = SOLO_LINKS.get(ref_key) or SOLO_LINKS.get(loop.index) %}
              {% if s_link %}
                <a href="{{ s_link }}" target="_blank" class="text-xs text-indigo-200 block mt-1 hover:underline">Open</a>
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Full grouped leaderboard (skip SOLO group) #}
    <div id="groupsContainer" class="space-y-5">
      {% if all_refs %}
        {% for group, teams in all_refs.items() %}
          {% if group != 'SOLO' %}
            <section class="group-section max-w-md mx-auto bg-white/10 border border-white/10 rounded-3xl p-4 shadow-lg backdrop-blur-md" data-group-name="{{ group }}">
              <header class="flex items-center justify-between mb-3">
                <div>
                  <h3 class="text-lg font-bold text-white">{{ group }}</h3>
                  <p class="text-xs text-gray-400">{{ teams|length }} teams</p>
                </div>
                <div class="text-xs text-gray-400">Sorted by referrals</div>
              </header>

              <div class="space-y-3">
                {% for tid, info in teams.items() %}
                  {% set referrals = info.referrals | default(0) %}
                  {% set pct = (referrals if referrals <= 100 else 100) %}
                  <article class="team-article p-3 rounded-xl bg-white/5 flex items-center justify-between gap-3 team-card"
                           data-tid="{{ tid }}" data-label="{{ info.team_label }}" data-group="{{ group }}"
                           style="animation: slideUpFade .45s ease both; animation-delay: {{ loop.index0 * 0.06 }}s;">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-gradient-to-br from-indigo-600 to-cyan-500 text-white font-bold shadow">
                        <div class="text-sm">{{ tid }}</div>
                      </div>
                      <div>
                        <div class="text-sm font-semibold text-white">{{ info.team_label }}</div>
                        <div class="text-xs text-gray-400">{{ group }}</div>
                      </div>
                    </div>

                    <div class="w-28 sm:w-36">
                      <div class="text-right text-sm font-bold text-cyan-300">{{ referrals }}</div>
                      <div class="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-2 bg-gradient-to-r from-cyan-400 to-indigo-500 rounded-full"
                             style="--w: {{ pct }}%; width: 0%; animation: growWidth 1.1s ease forwards; animation-delay: .18s;"></div>
                      </div>
                    </div>

                    <div class="flex flex-col items-end gap-2">
                      <a href="{{ TEAM_LINKS.get(tid|int, '#') }}" target="_blank"
                         class="px-3 py-1 rounded-lg bg-indigo-600 text-xs font-semibold hover:bg-indigo-500 transition">Open</a>
                      <div class="text-xs text-gray-400">Team {{ tid }}</div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="max-w-md mx-auto text-center text-gray-400 p-6 rounded-xl">No referral data available.</div>
      {% endif %}
    </div>

    <!-- No results element (hidden by default) -->
    <div id="noResults" class="max-w-md mx-auto no-results hidden">
      No matches found. Try a different search (team label, team number, group name, or REF code).
    </div>

    {% if user %}
    <div class="max-w-md mx-auto bg-white/10 border border-white/10 rounded-3xl p-4 shadow-lg backdrop-blur-md" style="animation: slideUpFade .45s ease both; animation-delay: .05s;">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-bold text-white">{{ user.name }}</div>
          <div class="text-xs text-gray-400">{{ user.group or "‚Äî" }} ¬∑ {{ user.team_label }}</div>
        </div>
        <div class="text-right">
          <div class="text-2xl font-extrabold text-cyan-300">{{ team_info.referrals | default(0) }}</div>
          <div class="text-xs text-gray-400">Team referrals</div>
        </div>
      </div>

      <div class="mt-3">
        {% if user.team_link %}
          <div class="flex gap-2">
            <input id="teamLink" readonly value="{{ user.team_link }}" class="flex-1 p-2 rounded-lg bg-white text-gray-900 font-mono"/>
            <button id="copyLinkBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-500">Copy</button>
          </div>
        {% else %}
          <div class="text-xs text-gray-400">No link assigned.</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
  // debounce helper
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  (function () {
    const input = document.getElementById('leaderboardSearch');
    const teamCards = () => Array.from(document.querySelectorAll('.team-card'));
    const soloCards = () => Array.from(document.querySelectorAll('.solo-card'));
    const groupSections = () => Array.from(document.querySelectorAll('.group-section'));
    const noResultsEl = document.getElementById('noResults');

    function normalize(s){
      return (s || '').toString().trim().toLowerCase();
    }

    function matchesQuery(el, q) {
      if (!q) return true;
      // check data attributes first
      const tid = normalize(el.dataset.tid || '');
      const label = normalize(el.dataset.label || el.textContent);
      const group = normalize(el.dataset.group || '');
      const refkey = normalize(el.dataset.refkey || '');
      // text snapshot
      const text = normalize(el.textContent || '');
      return tid.includes(q) || label.includes(q) || group.includes(q) || refkey.includes(q) || text.includes(q);
    }

    function runFilter() {
      const qRaw = input ? input.value : '';
      const q = normalize(qRaw);

      let visibleCount = 0;

      // filter team cards (top teams + group teams)
      teamCards().forEach(el => {
        const ok = matchesQuery(el, q);
        el.style.display = ok ? '' : 'none';
        if (ok) visibleCount++;
      });

      // filter solo cards
      soloCards().forEach(el => {
        const ok = matchesQuery(el, q);
        el.style.display = ok ? '' : 'none';
        if (ok) visibleCount++;
      });

      // hide entire group sections if none of their .team-card children visible
      groupSections().forEach(section => {
        const cards = Array.from(section.querySelectorAll('.team-card'));
        const anyVisible = cards.some(c => c.style.display !== 'none');
        section.style.display = anyVisible ? '' : 'none';
      });

      // Top teams block: hide if none visible inside it
      const topBlock = document.getElementById('topTeams');
      if (topBlock) {
        const anyTop = Array.from(topBlock.querySelectorAll('.team-card')).some(c => c.style.display !== 'none');
        topBlock.style.display = anyTop ? '' : 'none';
      }

      // Solo section
      const soloSection = document.getElementById('soloSection');
      if (soloSection) {
        const anySolo = Array.from(soloSection.querySelectorAll('.solo-card')).some(c => c.style.display !== 'none');
        soloSection.style.display = anySolo ? '' : 'none';
      }

      // Show no results when nothing visible
      if (visibleCount === 0) {
        noResultsEl.classList.remove('hidden');
      } else {
        noResultsEl.classList.add('hidden');
      }
    }

    const debounced = debounce(runFilter, 180);
    if (input) {
      input.addEventListener('input', debounced);
      // allow Enter to go to a progress page when user types a ref_id or name
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const val = normalize(input.value);
          if (!val) return;
          // quick heuristic: if value looks like a ref_id/name (no spaces or underscores preferred) redirect
          // we normalize similarly to server normalize_ref_id: lowercase, spaces->underscore, strip invalid
          const normalized = val.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
          window.location.href = `/progress/${normalized}`;
        }
      });
    }

    // run once on load to ensure initial state
    document.addEventListener('DOMContentLoaded', runFilter);
  })();
</script>
{% endblock %}
